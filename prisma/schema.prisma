generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model accounts {
  id                  String  @id
  user_id             String
  type                String
  provider            String
  provider_account_id String
  refresh_token       String?
  access_token        String?
  expires_at          Int?
  token_type          String?
  scope               String?
  id_token            String?
  session_state       String?
  users               users   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_account_id])
}

model contacts {
  id         String   @id
  user1      String
  user2      String
  accepted   Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime
}

model content_reports {
  id                                            String       @id
  reporter_id                                   String
  content_type                                  ContentType
  content_id                                    String
  reported_user_id                              String?
  reason                                        ReportReason
  custom_reason                                 String?
  status                                        ReportStatus @default(PENDING)
  reviewed_by_id                                String?
  reviewed_at                                   DateTime?
  resolution                                    String?
  created_at                                    DateTime     @default(now())
  updated_at                                    DateTime
  users_content_reports_reported_user_idTousers users?       @relation("content_reports_reported_user_idTousers", fields: [reported_user_id], references: [id])
  users_content_reports_reporter_idTousers      users        @relation("content_reports_reporter_idTousers", fields: [reporter_id], references: [id])
  users_content_reports_reviewed_by_idTousers   users?       @relation("content_reports_reviewed_by_idTousers", fields: [reviewed_by_id], references: [id])
}

model faq {
  id         String   @id
  question   String
  answer     String
  sort_order Int?
  created_at DateTime @default(now())
  updated_at DateTime
}

model messages {
  id                                String   @id
  sender_id                         String
  receiver_id                       String
  subject                           String?
  content                           String
  is_read                           Boolean  @default(false)
  created_at                        DateTime @default(now())
  users_messages_receiver_idTousers users    @relation("messages_receiver_idTousers", fields: [receiver_id], references: [id])
  users_messages_sender_idTousers   users    @relation("messages_sender_idTousers", fields: [sender_id], references: [id])
}

model notifications {
  id         String           @id
  user_id    String
  type       NotificationType
  title      String
  message    String
  data       Json?
  read       Boolean          @default(false)
  read_at    DateTime?
  action_url String?
  created_at DateTime         @default(now())
  updated_at DateTime
  users      users            @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model pending_subscriptions {
  id                     String        @id
  user_id                String
  studio_id              String
  paypal_subscription_id String?       @unique
  stripe_session_id      String?       @unique
  status                 String        @default("PENDING_APPROVAL")
  payment_method         PaymentMethod
  created_at             DateTime      @default(now())
  updated_at             DateTime
  studio_profiles        studio_profiles @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  users                  users         @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model poi {
  id          String   @id
  name        String
  description String?
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  address     String?
  category    String?
  created_at  DateTime @default(now())
  updated_at  DateTime
}

model refunds {
  id                       String       @id
  stripe_refund_id         String       @unique
  stripe_payment_intent_id String
  amount                   Int
  currency                 String
  reason                   String?
  comment                  String?      // Admin comment/note for the refund
  status                   RefundStatus
  processed_by             String
  user_id                  String?      // User being refunded (optional for backward compat)
  payment_id               String?      // Link to payment record (optional for backward compat)
  created_at               DateTime     @default(now())
  updated_at               DateTime
  users_refunds_processed_byTousers users @relation("refunds_processed_byTousers", fields: [processed_by], references: [id])
  users_refunds_user_idTousers      users? @relation("refunds_user_idTousers", fields: [user_id], references: [id])
  payments                 payments?    @relation(fields: [payment_id], references: [id])
  
  @@index([user_id])
  @@index([payment_id])
}

model payments {
  id                         String        @id
  user_id                    String
  stripe_checkout_session_id String?       @unique
  stripe_payment_intent_id   String?       @unique
  stripe_charge_id           String?       @unique
  amount                     Int           // Amount in smallest currency unit (pence)
  currency                   String        // e.g., "gbp"
  status                     PaymentStatus @default(PENDING)
  refunded_amount            Int           @default(0) // Amount refunded in smallest currency unit
  metadata                   Json?         // Store additional Stripe metadata
  created_at                 DateTime      @default(now())
  updated_at                 DateTime
  users                      users         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  refunds                    refunds[]
  
  @@index([user_id])
  @@index([status])
  @@index([created_at])
}

model stripe_webhook_events {
  id               String   @id
  stripe_event_id  String   @unique
  type             String
  payload          Json
  processed        Boolean  @default(false)
  processed_at     DateTime?
  error            String?
  created_at       DateTime @default(now())
  
  @@index([stripe_event_id])
  @@index([type])
  @@index([processed])
  @@index([created_at])
}

model review_responses {
  id         String   @id
  review_id  String   @unique
  author_id  String
  content    String
  created_at DateTime @default(now())
  updated_at DateTime
  users      users    @relation(fields: [author_id], references: [id], onDelete: Cascade)
  reviews    reviews  @relation(fields: [review_id], references: [id], onDelete: Cascade)
}

model reviews {
  id                               String            @id
  studio_id                        String
  reviewer_id                      String
  owner_id                         String
  rating                           Int               @db.SmallInt
  content                          String?
  is_anonymous                     Boolean           @default(false)
  status                           ReviewStatus      @default(PENDING)
  created_at                       DateTime          @default(now())
  updated_at                       DateTime
  review_responses                 review_responses?
  users_reviews_owner_idTousers    users             @relation("reviews_owner_idTousers", fields: [owner_id], references: [id])
  users_reviews_reviewer_idTousers users             @relation("reviews_reviewer_idTousers", fields: [reviewer_id], references: [id])
  studio_profiles                  studio_profiles   @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@index([studio_id])
}

model saved_searches {
  id         String   @id
  user_id    String
  name       String
  filters    String
  created_at DateTime @default(now())
  updated_at DateTime
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model sessions {
  id            String   @id
  session_token String   @unique
  user_id       String
  expires       DateTime
  users         users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model studio_images {
  id              String          @id
  studio_id       String
  image_url       String
  alt_text        String?
  sort_order      Int             @default(0)
  studio_profiles studio_profiles @relation(fields: [studio_id], references: [id], onDelete: Cascade)
}

model studio_services {
  id              String          @id
  studio_id       String
  service         ServiceType
  studio_profiles studio_profiles @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@unique([studio_id, service])
}

model studio_studio_types {
  id          String     @id
  studio_id   String
  studio_type StudioType
  studio_profiles studio_profiles @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@unique([studio_id, studio_type])
}

model studio_profiles {
  id                      String                  @id
  user_id                 String                  @unique
  
  // Studio identity
  name                    String
  description             String?
  short_about             String?
  about                   String?
  
  // Location
  full_address            String?
  abbreviated_address     String?
  city                    String                  @default("")
  location                String?
  latitude                Decimal?                @db.Decimal(10, 8)
  longitude               Decimal?                @db.Decimal(11, 8)
  show_exact_location     Boolean                 @default(true)
  
  // Contact
  phone                   String?
  website_url             String?
  show_email              Boolean                 @default(false)
  show_phone              Boolean                 @default(false)
  show_address            Boolean                 @default(false)
  show_directions         Boolean                 @default(false)
  
  // Professional
  equipment_list          String?
  services_offered        String?
  home_studio_description String?
  last_name               String?
  
  // Pricing
  rate_tier_1             String?
  rate_tier_2             String?
  rate_tier_3             String?
  show_rates              Boolean                 @default(false)
  
  // Social media
  facebook_url            String?
  twitter_url             String?
  x_url                   String?
  linkedin_url            String?
  instagram_url           String?
  tiktok_url              String?
  threads_url             String?
  youtube_url             String?
  vimeo_url               String?
  soundcloud_url          String?
  
  // Connections
  connection1             String?                 @db.VarChar(10)
  connection2             String?                 @db.VarChar(10)
  connection3             String?                 @db.VarChar(10)
  connection4             String?                 @db.VarChar(10)
  connection5             String?                 @db.VarChar(10)
  connection6             String?                 @db.VarChar(10)
  connection7             String?                 @db.VarChar(10)
  connection8             String?                 @db.VarChar(10)
  connection9             String?                 @db.VarChar(10)
  connection10            String?                 @db.VarChar(10)
  connection11            String?                 @db.VarChar(10)
  connection12            String?                 @db.VarChar(10)
  custom_connection_methods String[]
  
  // Status
  status                  StudioStatus            @default(ACTIVE)
  is_premium              Boolean                 @default(false)
  is_verified             Boolean                 @default(false)
  is_profile_visible      Boolean                 @default(true)
  is_featured             Boolean                 @default(false)
  featured_until          DateTime?
  is_spotlight            Boolean                 @default(false)
  is_crb_checked          Boolean                 @default(false)
  verification_level      String                  @default("none")
  use_coordinates_for_map Boolean                 @default(false)
  
  // Timestamps
  created_at              DateTime                @default(now())
  updated_at              DateTime
  
  // Relations
  users                   users                   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  studio_images           studio_images[]
  studio_services         studio_services[]
  studio_studio_types     studio_studio_types[]
  reviews                 reviews[]
  pending_subscriptions   pending_subscriptions[]
  profile_audit_findings  profile_audit_findings[]
  profile_audit_log       profile_audit_log[]
  
  @@index([user_id])
  @@index([city])
  @@index([location])
  @@index([status])
  @@index([is_premium])
  @@index([is_verified])
  @@index([is_featured])
  @@index([verification_level])
}

model subscriptions {
  id                     String             @id
  user_id                String
  stripe_subscription_id String?            @unique
  stripe_customer_id     String?
  paypal_subscription_id String?            @unique
  payment_method         PaymentMethod      @default(STRIPE)
  status                 SubscriptionStatus
  current_period_start   DateTime?
  current_period_end     DateTime?
  cancelled_at           DateTime?
  created_at             DateTime           @default(now())
  updated_at             DateTime
  users                  users              @relation(fields: [user_id], references: [id])
}

model user_connections {
  id                                              String   @id
  user_id                                         String
  connected_user_id                               String
  accepted                                        Boolean  @default(false)
  created_at                                      DateTime @default(now())
  users_user_connections_connected_user_idTousers users    @relation("user_connections_connected_user_idTousers", fields: [connected_user_id], references: [id])
  users_user_connections_user_idTousers           users    @relation("user_connections_user_idTousers", fields: [user_id], references: [id])

  @@unique([user_id, connected_user_id])
}

model user_metadata {
  id         String   @id
  user_id    String
  key        String
  value      String?
  created_at DateTime @default(now())
  updated_at DateTime
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, key])
  @@index([key])
  @@index([user_id])
}

// REMOVED: user_profiles model merged into studio_profiles

model users {
  id                                                         String                  @id
  email                                                      String                  @unique
  username                                                   String                  @unique
  display_name                                               String
  avatar_url                                                 String?
  role                                                       Role                    @default(USER)
  email_verified                                             Boolean                 @default(false)
  password                                                   String?
  reset_token                                                String?
  reset_token_expiry                                         DateTime?
  verification_token                                         String?
  verification_token_expiry                                  DateTime?
  deletion_requested_at                                      DateTime?
  deletion_scheduled_for                                     DateTime?
  deletion_status                                            String                  @default("ACTIVE")
  last_login                                                 DateTime?
  
  // Username reservation & payment tracking
  status                                                     UserStatus              @default(PENDING)
  reservation_expires_at                                     DateTime?
  payment_attempted_at                                       DateTime?
  payment_retry_count                                        Int                     @default(0)
  day2_reminder_sent_at                                      DateTime?
  day5_reminder_sent_at                                      DateTime?
  failed_payment_email_sent_at                               DateTime?
  
  created_at                                                 DateTime                @default(now())
  updated_at                                                 DateTime
  accounts                                                   accounts[]
  content_reports_content_reports_reported_user_idTousers    content_reports[]       @relation("content_reports_reported_user_idTousers")
  content_reports_content_reports_reporter_idTousers         content_reports[]       @relation("content_reports_reporter_idTousers")
  content_reports_content_reports_reviewed_by_idTousers      content_reports[]       @relation("content_reports_reviewed_by_idTousers")
  messages_messages_receiver_idTousers                       messages[]              @relation("messages_receiver_idTousers")
  messages_messages_sender_idTousers                         messages[]              @relation("messages_sender_idTousers")
  notifications                                              notifications[]
  pending_subscriptions                                      pending_subscriptions[]
  refunds_refunds_processed_byTousers                        refunds[]               @relation("refunds_processed_byTousers")
  refunds_refunds_user_idTousers                             refunds[]               @relation("refunds_user_idTousers")
  payments                                                   payments[]
  review_responses                                           review_responses[]
  reviews_reviews_owner_idTousers                            reviews[]               @relation("reviews_owner_idTousers")
  reviews_reviews_reviewer_idTousers                         reviews[]               @relation("reviews_reviewer_idTousers")
  saved_searches                                             saved_searches[]
  sessions                                                   sessions[]
  studio_profiles                                            studio_profiles?
  subscriptions                                              subscriptions[]
  user_connections_user_connections_connected_user_idTousers user_connections[]      @relation("user_connections_connected_user_idTousers")
  user_connections_user_connections_user_idTousers           user_connections[]      @relation("user_connections_user_idTousers")
  user_metadata                                              user_metadata[]
  support_tickets                                            support_tickets[]
  profile_audit_findings                                     profile_audit_findings[]
  profile_enrichment_suggestions_reviewed                    profile_enrichment_suggestions[] @relation("suggestions_reviewed_by")
  profile_audit_log_user                                     profile_audit_log[]     @relation("audit_log_user")
  profile_audit_log_performer                                profile_audit_log[]     @relation("audit_log_performer")
}

model waitlist {
  id         String   @id
  name       String
  email      String
  created_at DateTime @default(now())

  @@index([created_at])
}

model support_tickets {
  id          String              @id
  user_id     String
  type        SupportTicketType
  category    String
  subject     String?
  message     String
  status      SupportTicketStatus @default(OPEN)
  priority    SupportPriority     @default(MEDIUM)
  assigned_to String?
  resolved_at DateTime?
  created_at  DateTime            @default(now())
  updated_at  DateTime

  users users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([status])
  @@index([type])
  @@index([created_at])
}

model error_log_groups {
  id                String         @id
  sentry_issue_id   String         @unique
  title             String
  level             String         // error, fatal, warning, info
  status            ErrorLogStatus @default(OPEN)
  first_seen_at     DateTime
  last_seen_at      DateTime
  event_count       Int            @default(1)
  environment       String?
  release           String?
  last_event_id     String?
  sample_event_json Json?
  created_at        DateTime       @default(now())
  updated_at        DateTime

  @@index([last_seen_at])
  @@index([status])
  @@index([level])
  @@index([event_count])
  @@index([created_at])
}

enum ContentType {
  REVIEW
  MESSAGE
  STUDIO
  USER
}

enum NotificationType {
  MESSAGE_RECEIVED
  REVIEW_RECEIVED
  REVIEW_RESPONSE
  CONNECTION_REQUEST
  CONNECTION_ACCEPTED
  STUDIO_VERIFIED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  SUBSCRIPTION_EXPIRING
}

enum PaymentMethod {
  STRIPE
  PAYPAL
}

enum PaymentStatus {
  PENDING
  PROCESSING
  REQUIRES_PAYMENT_METHOD
  REQUIRES_CONFIRMATION
  REQUIRES_ACTION
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum RefundStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELLED
}

enum ReportReason {
  SPAM
  HARASSMENT
  HATE_SPEECH
  INAPPROPRIATE
  FAKE_INFO
  COPYRIGHT
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Role {
  USER
  ADMIN
}

enum ServiceType {
  ISDN
  SOURCE_CONNECT
  SOURCE_CONNECT_NOW
  CLEANFEED
  SESSION_LINK_PRO
  ZOOM
  SKYPE
  TEAMS
}

enum StudioStatus {
  DRAFT
  ACTIVE
  INACTIVE
  PENDING
}

enum StudioType {
  HOME
  RECORDING
  VO_COACH
  AUDIO_PRODUCER
  PODCAST
  VOICEOVER
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  UNPAID
  INCOMPLETE
  SUSPENDED
}

enum SupportTicketType {
  ISSUE
  SUGGESTION
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SupportPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model admin_sticky_notes {
  id         String   @id
  key        String   @unique
  content    String   @db.Text
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

// Profile Audit System
model profile_audit_findings {
  id                    String                  @id
  user_id               String
  studio_profile_id     String?
  classification        AuditClassification
  reasons               Json                     // Array of reason strings
  completeness_score    Int                      // 0-100
  recommended_action    String?
  metadata              Json?                    // Additional classification data
  created_at            DateTime                 @default(now())
  updated_at            DateTime                 @updatedAt
  users                 users                    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  studio_profiles       studio_profiles?         @relation(fields: [studio_profile_id], references: [id], onDelete: Cascade)
  enrichment_suggestions profile_enrichment_suggestions[]
  
  @@index([user_id])
  @@index([classification])
  @@index([completeness_score])
  @@index([created_at])
}

model profile_enrichment_suggestions {
  id                    String                  @id
  audit_finding_id      String
  field_name            String                   // e.g., "website_url", "city", "phone"
  current_value         String?                  // Current value (null if missing)
  suggested_value       String                   // Proposed value
  confidence            EnrichmentConfidence
  evidence_url          String?                  // Source URL for the suggestion
  evidence_type         String?                  // e.g., "website", "social", "places_api"
  status                SuggestionStatus         @default(PENDING)
  reviewed_by_id        String?
  reviewed_at           DateTime?
  applied_at            DateTime?
  created_at            DateTime                 @default(now())
  updated_at            DateTime                 @updatedAt
  audit_finding         profile_audit_findings   @relation(fields: [audit_finding_id], references: [id], onDelete: Cascade)
  reviewed_by           users?                   @relation("suggestions_reviewed_by", fields: [reviewed_by_id], references: [id])
  
  @@index([audit_finding_id])
  @@index([status])
  @@index([confidence])
  @@index([field_name])
  @@index([created_at])
}

model profile_audit_log {
  id                    String                  @id
  suggestion_id         String?                  // Optional link to suggestion that triggered this
  user_id               String
  studio_profile_id     String?
  action                AuditLogAction
  field_name            String?
  old_value             String?
  new_value             String?
  evidence_url          String?
  performed_by_id       String
  notes                 String?
  created_at            DateTime                 @default(now())
  users                 users                    @relation("audit_log_user", fields: [user_id], references: [id], onDelete: Cascade)
  studio_profiles       studio_profiles?         @relation(fields: [studio_profile_id], references: [id], onDelete: Cascade)
  performed_by          users                    @relation("audit_log_performer", fields: [performed_by_id], references: [id])
  
  @@index([user_id])
  @@index([studio_profile_id])
  @@index([action])
  @@index([performed_by_id])
  @@index([created_at])
}

enum AuditClassification {
  JUNK
  NEEDS_UPDATE
  NOT_ADVERTISING
  EXCEPTION
  HEALTHY
}

enum EnrichmentConfidence {
  HIGH
  MEDIUM
  LOW
}

enum SuggestionStatus {
  PENDING
  APPROVED
  REJECTED
  APPLIED
}

enum AuditLogAction {
  FIELD_UPDATE
  STATUS_CHANGE
  VISIBILITY_CHANGE
  BULK_UPDATE
  MANUAL_REVIEW
}

enum UserStatus {
  PENDING
  ACTIVE
  EXPIRED
}

enum ErrorLogStatus {
  OPEN
  RESOLVED
  IGNORED
}
